machine:
  services:
    - docker
  post:
    - wget -qO- get.nextflow.io | bash ; chmod 755 nextflow ; sudo ln -s ~/nextflow /usr/local/bin/ ; sudo apt-get install graphviz
    - git clone --depth=1 https://github.com/IARCbioinfo/data_test.git

test:
  override:
    - | # run manually docker to do not search for :latest image on dockerhub
      cd ~/platypus-nf
      docker build -t iarcbioinfo/platypus-nf .
    - | # execute the tests
      cd ~ && nextflow run ~/platypus-nf/platypus.nf -with-docker iarcbioinfo/platypus-nf --help
    - | # test
      cd ~ && nextflow run ~/platypus-nf/platypus.nf -with-docker iarcbioinfo/platypus-nf --input_folder ~/data_test/BAM/ --ref ~/data_test/REF/17.fasta
    - | # test --region option
      cd ~ && nextflow run ~/platypus-nf/platypus.nf -with-docker iarcbioinfo/platypus-nf --input_folder ~/data_test/BAM/ --ref ~/data_test/REF/17.fasta --region BED/TP53_small.bed
    - | # test --compression option
      cd ~ && nextflow run ~/platypus-nf/platypus.nf -with-docker iarcbioinfo/platypus-nf --input_folder ~/data_test/BAM/ --ref ~/data_test/REF/17.fasta --compression
    - | # test both --compression and --filter option
      cd ~ && nextflow run ~/platypus-nf/platypus.nf -with-docker iarcbioinfo/platypus-nf --input_folder ~/data_test/BAM/ --ref ~/data_test/REF/17.fasta --compression --filter
      mv nf-pipeline_info/platypus-nf_dag.html ~/platypus-nf/

deployment:
  git:
    branch: [master, dev]
    commands:
    - chmod +x deploy.sh && ./deploy.sh
